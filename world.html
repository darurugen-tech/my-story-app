<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app-container">

    <div class="header" style="justify-content: space-between;">
        <div onclick="location.href='index.html'" style="cursor: pointer; width: 40px;">
            <img src="images/icons/icon_back.png" class="icon-back-special" alt="Back">
        </div>
        
        <div class="logo-text" id="page-title" style="flex:1; text-align:center;">
            World
        </div>
        
        <div style="width: 40px; text-align: right;">
            <img id="theme-btn" src="images/icons/icon_sun.png" style="width: 24px; height: 24px;" onclick="toggleThemeLocal()">
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search..." onkeyup="handleLocalSearch(event)">
        <button onclick="localSearch()">
            <img src="images/icons/icon_search.png" alt="Search">
        </button>
    </div>

    <div class="story-grid" id="grid-container"></div>

</div>

<script src="stories.js"></script>
<script src="app.js"></script>

<script>
    // 1. THEME CHECK
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "light") {
        document.body.classList.add("light-mode");
        document.getElementById("theme-btn").src = "images/icons/icon_moon.png";
    }

    // 2. TOGGLE FUNCTION
    function toggleThemeLocal() {
        document.body.classList.toggle("light-mode");
        const btn = document.getElementById("theme-btn");
        if (document.body.classList.contains("light-mode")) {
            localStorage.setItem("theme", "light");
            btn.src = "images/icons/icon_moon.png";
        } else {
            localStorage.setItem("theme", "dark");
            btn.src = "images/icons/icon_sun.png";
        }
    }

    const params = new URLSearchParams(window.location.search);
    const type = params.get('type'); 
    const query = params.get('q'); 

    const titles = { 
        comic: "Comic World", 
        novel: "Novel World", 
        story: "Story World", 
        search: "Global Search" 
    };
    document.getElementById("page-title").innerText = titles[type] || "World";

    if (query) document.getElementById("search-input").value = query;

    const container = document.getElementById("grid-container");
    container.innerHTML = ""; 

    let count = 0;

    for (let key in db) {
        let item = db[key];
        let match = true;

        // ðŸ›‘ NEW CODE: SKIP IF NOT RELEASED
        if (item.released === false) { continue; } 

        if (item.hidden === true) { continue; }

        if (type !== 'search' && item.type !== type) match = false;

        if (query) {
            const searchText = query.toLowerCase();
            const titleMatch = item.title.toLowerCase().includes(searchText);
            const authorMatch = item.author.toLowerCase().includes(searchText);
            if (!titleMatch && !authorMatch) match = false;
        }

        if (match) {
            count++;
            let badgeHTML = "";
            if (item.badge) {
                let badgeClass = (item.badge === "NEW") ? "badge-new" : "badge-up";
                badgeHTML = `<span class="badge ${badgeClass}">${item.badge}</span>`;
            }

            container.innerHTML += `
                <div class="story-card" onclick="location.href='view.html?id=${item.id}'">
                    ${badgeHTML}
                    <img src="${item.cover}" class="story-cover">
                    <div class="story-title">${item.title}</div>
                    <div class="story-stats">${item.stats}</div>
                </div>
            `;
        }
    }

    if (count === 0) {
        container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:gray;">
            <h3>No results found</h3>
            <p>We couldn't find anything for "${query || type}"</p>
        </div>`;
    }

    function handleLocalSearch(event) {
        if (event.key === 'Enter') localSearch();
    }

    function localSearch() {
        const inputVal = document.getElementById("search-input").value;
        if (inputVal.trim() !== "") location.href = `world.html?type=${type}&q=${inputVal}`;
        else location.href = `world.html?type=${type}`;
    }
</script>
</body>
</html>