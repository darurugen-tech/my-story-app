<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>AAN Reader</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="apple-touch-icon" href="images/icons/app_icon.png">
    <link rel="icon" type="image/png" href="images/icons/app_icon.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AAN Reader">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
</head>
<body>
<div class="app-container">

    <div class="header" style="justify-content: space-between;">
        <div onclick="location.href='index.html'" style="cursor: pointer; width: 40px; display:flex; align-items:center;">
            <img src="images/icons/icon_back.png" class="icon-back-special" alt="Back">
        </div>
        
        <div class="logo-text" id="page-title" style="flex:1; text-align:center;">
            World
        </div>
        
        <div class="icon-box" onclick="toggleTheme()" style="width: 40px; align-items: flex-end;">
            <img id="theme-btn" src="images/icons/icon_sun.png" class="icon-btn">
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search title or author..." 
            oninput="liveSearch(this.value)" autocomplete="off">
        <button>
            <img src="images/icons/icon_search.png" alt="Search">
        </button>
    </div>

    <div class="world-list-container" id="grid-container"></div>

</div>

<script src="stories.js"></script>
<script src="app.js"></script>

<script>
    // --- 1. SETUP & INITIALIZATION ---
    const params = new URLSearchParams(window.location.search);
    const type = params.get('type') || 'all'; // Default to 'all' if no type
    const container = document.getElementById("grid-container");

    // Set Page Title
    const titles = { 
        comic: "Comic World", 
        novel: "Novel World", 
        story: "Story World", 
        search: "All Stories",
        all: "All Stories"
    };
    document.getElementById("page-title").innerText = titles[type] || "World";

    // --- 2. RENDER FUNCTION (Draws the list) ---
    function renderList(filterText = "") {
        container.innerHTML = ""; // Clear current list
        let count = 0;
        const searchLower = filterText.toLowerCase();

        for (let key in db) {
            let item = db[key];

            // Safety Checks
            if (item.released === false) continue;
            if (item.hidden === true) continue;

            // 1. Filter by Category (unless we are in 'search' or 'all' mode)
            if (type !== 'search' && type !== 'all' && item.type !== type) {
                continue;
            }

            // 2. Filter by Search Text (Live Typing)
            // If filterText is empty, this part is skipped (shows all)
            if (searchLower) {
                const titleMatch = item.title.toLowerCase().includes(searchLower);
                const authorMatch = (item.author || "").toLowerCase().includes(searchLower);
                if (!titleMatch && !authorMatch) continue; // Skip if no match
            }

            // If we get here, show the item!
            count++;
            
            // Render HTML
            let genre = item.stats.split('â€¢')[0].trim();
            
            container.innerHTML += `
                <div class="list-item">
                    <div class="list-cover-wrapper" onclick="location.href='view.html?id=${item.id}'">
                        <div style="position:relative; width:100%;">
                            ${item.badge ? `<span class="badge ${item.badge === 'NEW' ? 'badge-new' : 'badge-up'}">${item.badge}</span>` : ''}
                            <img src="${item.cover}" class="list-cover-img">
                        </div>
                    </div>

                    <div class="list-info-box" onclick="location.href='view.html?id=${item.id}'">
                        <div class="list-info-title">${item.title}</div>
                        <div class="list-info-stats">${item.stats}</div>
                        <div class="list-info-summary">
                            ${item.desc || item.summary || "No description available."}
                        </div>
                    </div>
                </div>
            `;
        }

        // Show "No Results" message if empty
        if (count === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:50px; color:gray;">
                    <h3>No results found</h3>
                    <p>Try searching for something else.</p>
                </div>`;
        }
    }

    // --- 3. LIVE SEARCH HANDLER ---
    function liveSearch(text) {
        renderList(text);
    }

    // --- 4. RUN ON LOAD ---
    // Render the full list immediately when page opens
    renderList(""); 

    // Sync Theme Icon (Optional)
    const savedTheme = localStorage.getItem("theme");
    if(savedTheme === 'light') {
        document.getElementById("theme-btn").src = "images/icons/icon_moon.png";
    }
</script>
</body>
</html>