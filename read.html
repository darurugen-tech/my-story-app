<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>AAN Reader</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="apple-touch-icon" href="images/icons/app_icon.png">
    <link rel="icon" type="image/png" href="images/icons/app_icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AAN Reader">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
</head>
<body class="read-page-body">
<div class="app-container">

    <div class="header read-page-header" style="padding: 15px 20px;">
        
        <div onclick="goBack()" style="cursor: pointer; z-index: 20; flex: 0 0 50px; display: flex; align-items: center;">
            <img src="images/icons/icon_back.png" class="icon-back-special" alt="Back">
        </div>

        <div class="reader-header-content">
            <div id="r-title" style="font-size:16px; font-weight:bold; text-align: center; line-height: 1.2;">Loading...</div>
            <select id="ep-select" onchange="jumpToEp(this.value)" style="display:none;"></select>
        </div>

        <div class="icon-box" onclick="toggleTheme()" style="flex: 0 0 50px; display: flex; align-items: center; justify-content: flex-end;">
            <img id="theme-btn" src="images/icons/icon_sun.png" class="icon-btn">
        </div>
        
    </div>

    <div id="content-area" class="read-container"></div>

    <div class="read-page-footer" style="padding: 15px 40px; box-sizing: border-box;">
        <button id="btn-prev-big" onclick="handlePrev()">Previous</button>
        <button id="btn-next-big" onclick="handleNext()">Next Episode</button>
    </div>

    <div id="end-popup" class="popup-overlay">
        <div class="popup-box">
            <h3 style="font-weight: normal;">អ្នកបានមកដល់ទំព័រចុងក្រោយ</h3>
            <p style="font-size: 17px; margin-top: 0; margin-bottom: 0px; color: #7bff86;">
                You have reached the end of the available episodes.
            </p>
            <button class="popup-btn" onclick="closePopup()" 
    style="width: auto; padding: 10px 40px; background-color: #33b13d; color: white;">
    Okay
</button>
        </div>
    </div>
</div>

<script src="stories.js"></script>
<script src="app.js"></script>

<script>
    // ... (Your existing top code) ...

    // 1. FIXED BACK FUNCTION
    function goBack() {
        // This takes you back to the previous page in history (View Page)
        // without adding a new "layer" to the history stack.
        history.back();
    }

    // ... (Rest of your existing code below) ...
    
    // IF YOU WANT THE FULL SCRIPT UPDATED, HERE IT IS:
    // ------------------------------------------------

    // --- 3. STORY LOADING LOGIC ---
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const lang = params.get('lang'); 
    let ep = parseInt(params.get('ep')); 

    if(id && !isNaN(ep)) localStorage.setItem('last_read_' + id, ep);

    
    
    // We don't really need 'fromWhere' anymore if we use history.back()
    const fromWhere = params.get('from');
    const fromString = fromWhere ? `&from=${fromWhere}` : "";

    const data = db[id];
    const container = document.getElementById("content-area");
    const selectBox = document.getElementById("ep-select");

    if (data) {
        if (data.type === "story") {
            document.getElementById("r-title").innerText = data.title;
            let episodes = (lang === 'kh') ? data.episodes_kh : data.episodes_en;
            if (episodes && episodes[ep]) {
                setupDropdown(episodes, true);
                renderContent(episodes[ep]);
                updateNavButtons(); 
            }
        } else if (data.episodes && data.episodes[ep]) {
            document.getElementById("r-title").innerText = data.title;
            setupDropdown(data.episodes, false);
            renderContent(data.episodes[ep]);
            updateNavButtons(); 
        }
    }
    

    // --- RENDER CONTENT (Sign Only for Novels) ---
    function renderContent(source) {
        container.innerHTML = ""; 
        container.removeAttribute("style");
        
        // 1. Prepare End Sign (Same as before)
        const endSignHTML = `
            <div class="end-sign-wrapper" style="text-align: center; margin-top: 50px; margin-bottom: 50px;">
                <img src="images/icons/end_sign.jpg" class="end-sign-img">
            </div>
        `;

        if (Array.isArray(source)) {
            let firstItem = source[0] || "";
            
            // --- A. IMAGE MODE (Stories & Comics) ---
            if (firstItem.includes("images/") || firstItem.includes(".jpg") || firstItem.includes(".png")) {
                
                // 1. Horizontal Mode (Stories)
                if (data.type === "story") {
                    container.className = "read-container horizontal-mode";
                    source.forEach(imgSrc => {
                        container.innerHTML += `<img src="${imgSrc}">`;
                    });
                    // REMOVED: container.innerHTML += endSignHTML; 
                } 
                // 2. Vertical Mode (Comics)
                else {
                    container.className = "read-container image-mode";
                    container.style.marginTop = ""; 
                    container.style.height = "";
                    source.forEach(imgSrc => {
                        container.innerHTML += `<img src="${imgSrc}">`;
                    });
                    // REMOVED: container.innerHTML += endSignHTML;
                }
            } 
            
            // --- B. TEXT MODE (Novels) ---
            else {
                container.className = "read-container text-mode";
                container.style.fontSize = "18px";     
                container.style.lineHeight = "1.8";    
                container.style.padding = "100px 20px 100px 20px";
                container.style.fontFamily = "'Noto Sans Khmer', sans-serif";
                container.style.textAlign = "left";

                let htmlContent = source.map(line => 
                    `<div style="margin-bottom: 20px;">${line}</div>`
                ).join(""); 

                const customStyles = `
                    <style>
                        .chapter-title {
                            font-size: 24px !important;    
                            font-weight: bold !important;  
                            text-align: center !important; 
                            color: var(--text-color) !important; 
                            margin-top: 30px !important;
                            margin-bottom: 30px !important;
                            line-height: 1.6 !important;
                        }
                    </style>
                `;

                // KEEP THIS: Only add the sign here
                container.innerHTML = customStyles + htmlContent + endSignHTML;
            }
        } else {
            // C. Legacy String Mode (Treat as Novel)
            container.className = "read-container text-mode";
            container.style.fontSize = "22px";
            container.style.lineHeight = "2.0";
            container.innerHTML = `<p>${source}</p>` + endSignHTML;
        }
    }

    // --- 4. HIDE PREVIOUS BUTTON LOGIC (SMART VERSION) ---
    function updateNavButtons() {
        const btnPrev = document.getElementById("btn-prev-big");
        
        // 1. Get the correct list of episodes based on type and language
        let episodesObj = null;
        if (data.type === "story") {
            episodesObj = (lang === 'kh') ? data.episodes_kh : data.episodes_en;
        } else {
            episodesObj = data.episodes;
        }

        if (!episodesObj) return;

        // 2. Get all episode numbers and sort them (Smallest to Largest)
        // We use parseInt so "10" is correctly larger than "2"
        const sortedKeys = Object.keys(episodesObj).sort((a, b) => parseInt(a) - parseInt(b));
        
        // 3. Find the very first episode number
        const firstEp = sortedKeys[0];

        // 4. If current episode matches the first one, Hide Previous Button
        if (ep == firstEp) {
            btnPrev.style.display = "none";
        } else {
            btnPrev.style.display = "block";
        }
    }

    function jumpToEp(newEp) {
        // Here we use location.replace so we don't build up history when switching chapters
        let url = `read.html?id=${id}&ep=${newEp}${fromString}`;
        if (lang) url += `&lang=${lang}`;
        location.replace(url); 
    }

    function setupDropdown(episodes, isStory) {
        selectBox.style.display = "block";
        selectBox.innerHTML = ""; 
        Object.keys(episodes).sort((a,b) => a - b).forEach(epNum => {
            let option = document.createElement("option");
            option.value = epNum;
            if(isStory) {
                option.text = (epNum == '0') ? "Intro" : ((lang === 'kh' ? 'ភាគ ' : 'Episode ') + epNum);
            } else {
                option.text = (epNum == '0') ? "អារម្ភកថា" : ((data.type === "novel" ? "ជំពូក " : "ភាគ ") + epNum);
            }
            if (parseInt(epNum) === ep) option.selected = true;
            selectBox.appendChild(option);
        });
    }

    // --- NAVIGATION ---
    function handleNext() {
        let episodes = (data.type === "story") ? ((lang === 'kh') ? data.episodes_kh : data.episodes_en) : data.episodes;
        if (episodes[ep + 1]) {
            jumpToEp(ep + 1);
        } else {
            document.getElementById("end-popup").style.display = "flex";
        }
    }

    function handlePrev() {
        if (ep > 0) {
            jumpToEp(ep - 1);
        }
    }

    function closePopup() { document.getElementById("end-popup").style.display = "none"; }

    
</script>
</body>
</html>