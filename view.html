<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail View</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app-container">

    <div class="header">
        <div onclick="history.back()" style="cursor: pointer;">
            <img src="images/icons/icon_back.png" class="icon-back-special" alt="Back">
        </div>

        <div class="header-icons">
            <div class="icon-box" onclick="toggleThemeLocal()">
                <img id="theme-btn" src="images/icons/icon_sun.png" class="icon-btn">
                <span id="theme-text" class="icon-label">Light</span>
            </div>
            <div class="icon-box">
                <img id="btn-save" src="images/icons/icon_bookmark.png" class="icon-btn">
                <span class="icon-label">Saved</span>
            </div>
        </div>
    </div>

    <div class="detail-top-section">
        <img id="d-cover" src="" class="detail-cover-img">
        
        <div class="detail-info-box">
            <h2 id="d-title">Loading...</h2>
            <div id="d-stats" class="detail-meta" style="color:#aaa;"></div>
            
            <div class="detail-meta">
                <span style="color:var(--text-color); font-weight:bold;">Writer:</span> <span id="d-author"></span><br>
                <span style="color:var(--text-color); font-weight:bold;">Year:</span> <span id="d-year"></span>
            </div>

            <div id="d-desc" class="detail-desc-preview"></div>
        </div>
    </div>

    <div id="warning-container" class="warning-box" style="display:none;">
        <span id="d-warning"></span>
    </div>

    <div id="lang-container" class="lang-toggle-container" style="display:none;">
        <button id="btn-kh" class="lang-btn active" onclick="switchLang('kh')">Khmer</button>
        <button id="btn-en" class="lang-btn" onclick="switchLang('en')">English</button>
    </div>

    <div class="chapter-section-title">មាតិកា (Chapter)</div>
    
    <div class="chapter-list-box" id="chapter-list">
        </div>

    <div class="footer">
        © 2026 AAN. All Rights Reserved.
    </div>

    <div id="toast-notification">Notification</div>

</div>

<script src="stories.js"></script>
<script src="app.js"></script> 

<script>
    // --- 1. THEME LOGIC ---
    const themeBtn = document.getElementById("theme-btn");
    const themeText = document.getElementById("theme-text");

    function updateThemeUI(isLight) {
        if (isLight) {
            document.body.classList.add("light-mode");
            if(themeBtn) themeBtn.src = "images/icons/icon_moon.png";
            if(themeText) themeText.innerText = "Dark";
        } else {
            document.body.classList.remove("light-mode");
            if(themeBtn) themeBtn.src = "images/icons/icon_sun.png";
            if(themeText) themeText.innerText = "Light";
        }
    }
    const savedTheme = localStorage.getItem("theme");
    updateThemeUI(savedTheme === "light");

    function toggleThemeLocal() {
        document.body.classList.toggle("light-mode");
        const isLight = document.body.classList.contains("light-mode");
        localStorage.setItem("theme", isLight ? "light" : "dark");
        updateThemeUI(isLight);
    }

    // --- 2. LOAD DATA ---
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    
    // Store current active language ('kh' or 'en')
    let currentLang = 'kh'; 
    let data = null;

    if (typeof db !== 'undefined') {
        data = db[id];
        if (data) {
            // A. Populate Basic Info
            document.getElementById("d-cover").src = data.cover;
            document.getElementById("d-title").innerText = data.title;
            document.getElementById("d-stats").innerText = data.stats;
            document.getElementById("d-author").innerText = data.author || "Unknown";
            document.getElementById("d-year").innerText = data.year || "N/A";
            document.getElementById("d-desc").innerText = data.desc;

            // B. Warning Logic
            if (data.warning && data.warning.trim() !== "") {
                document.getElementById("warning-container").style.display = "block";
                document.getElementById("d-warning").innerText = data.warning;
            }

            // C. Language Logic
            // Check availability
            const hasKh = !!data.episodes_kh || (data.type !== 'story' && data.episodes); // Non-story types usually store in 'episodes'
            const hasEn = !!data.episodes_en;

            const langContainer = document.getElementById("lang-container");

            if (data.type === 'story') {
                if (hasKh && hasEn) {
                    langContainer.style.display = "flex"; // Show Toggle
                    switchLang('kh'); // Default to Khmer
                } else if (hasEn) {
                    langContainer.style.display = "none";
                    currentLang = 'en';
                    renderChapters(data.episodes_en, 'en');
                } else {
                    langContainer.style.display = "none";
                    currentLang = 'kh';
                    renderChapters(data.episodes_kh, 'kh');
                }
            } else {
                // For Novels/Comics (usually single language structure in your DB)
                langContainer.style.display = "none";
                renderChapters(data.episodes, 'default');
            }

            // D. Bookmark Logic (Same as before)
            setupBookmarkButton(data);
        }
    }

    // --- 3. SWITCH LANGUAGE FUNCTION ---
    function switchLang(lang) {
        currentLang = lang;
        
        // Update Buttons UI
        document.getElementById('btn-kh').className = (lang === 'kh') ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btn-en').className = (lang === 'en') ? 'lang-btn active' : 'lang-btn';

        // Render List
        if (lang === 'kh') renderChapters(data.episodes_kh, 'kh');
        else renderChapters(data.episodes_en, 'en');
    }

    // --- 4. RENDER CHAPTERS (Scrollable Box) ---
    function renderChapters(episodesData, langCode) {
        const listDiv = document.getElementById("chapter-list");
        listDiv.innerHTML = ""; // Clear existing

        if (!episodesData) {
            listDiv.innerHTML = "<div style='padding:20px; text-align:center; color:#666;'>No chapters available.</div>";
            return;
        }

        // Get keys and Sort Descending (Newest first)
        // Note: '0' (Intro) should usually be at bottom or top? User said "Last one is on the top". 
        // Assuming keys are "1", "2", "3". Sort b - a.
        let keys = Object.keys(episodesData).sort((a, b) => b - a);

        // Get Last Read from LocalStorage
        // Key format: "last_read_storyId" -> returns epNum
        const lastReadEp = localStorage.getItem('last_read_' + id);

        keys.forEach(epNum => {
            let label = "";
            if (epNum == '0') label = "Intro / Prologue";
            else label = (data.type === "novel" ? "Chapter " : "Episode ") + epNum;
            
            // Add custom Khmer label if needed
            if (langCode === 'kh' || (langCode === 'default' && data.type === 'novel')) {
                 if (epNum == '0') label = "អារម្ភកថា";
                 else label = (data.type === "novel" ? "ជំពូកទី " : "ភាគ ") + epNum;
            }

            // Check if this is the last read one
            let activeClass = (lastReadEp == epNum) ? " last-read" : "";

            // Create HTML
            let row = document.createElement("div");
            row.className = "chapter-row" + activeClass;
            row.innerHTML = `
                <span>${label}</span>
                <span class="free-tag">FREE</span>
            `;
            
            // On Click -> Go to Read
            row.onclick = function() {
                // Save this as last read
                localStorage.setItem('last_read_' + id, epNum);
                
                // Navigate
                let url = `read.html?id=${id}&ep=${epNum}`;
                if (langCode !== 'default') url += `&lang=${langCode}`;
                location.href = url;
            };

            listDiv.appendChild(row);
        });
    }

    // --- 5. BOOKMARK SETUP ---
    function setupBookmarkButton(item) {
        const btnSave = document.getElementById("btn-save");
        let bookmarks = JSON.parse(localStorage.getItem("khatoon_bookmarks")) || [];
        
        // Check initial state
        let isSaved = bookmarks.some(b => b.id === item.id);
        btnSave.src = isSaved ? "images/icons/icon_bookmark_red.png" : "images/icons/icon_bookmark.png";

        btnSave.onclick = function() {
            bookmarks = JSON.parse(localStorage.getItem("khatoon_bookmarks")) || [];
            let index = bookmarks.findIndex(b => b.id === item.id);

            if (index > -1) {
                bookmarks.splice(index, 1);
                btnSave.src = "images/icons/icon_bookmark.png";
                showToast("Removed from Library");
            } else {
                bookmarks.push({ id: item.id, title: item.title, type: item.type, cover: item.cover });
                btnSave.src = "images/icons/icon_bookmark_red.png";
                showToast("Saved to Library");
            }
            localStorage.setItem("khatoon_bookmarks", JSON.stringify(bookmarks));
        };
    }

    function showToast(msg) {
        const t = document.getElementById("toast-notification");
        t.innerText = msg;
        t.className = "show";
        setTimeout(() => t.className = t.className.replace("show", ""), 3000);
    }
</script>
</body>
</html>