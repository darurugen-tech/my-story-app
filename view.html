<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app-container">

    <div class="header">
        <div onclick="goUp()" style="cursor: pointer;">
            <img src="images/icons/icon_back.png" class="icon-back-special" alt="Back">
        </div>
        <img id="btn-save" src="images/icons/icon_bookmark.png" class="icon-btn" alt="Save">
    </div>

    <div class="detail-header" style="display: flex; align-items: flex-start; gap: 15px; padding: 20px;">
        
        <img id="d-cover" src="" style="width: 125px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">

        <div class="detail-info" style="flex: 1;">
            <h2 id="d-title" style="margin: 0 0 5px 0; font-size: 22px; color: var(--text-color);">Loading...</h2>
            <div id="d-stats" style="font-size: 14px; color: gray; margin-bottom: 12px;"></div>

            <div class="meta-data" style="font-size: 14px; line-height: 1.6; color: var(--text-color);">
                <p style="margin: 0;"><strong>Writer:</strong> <span id="d-author" style="color: var(--sub-text);"></span></p>
                <p style="margin: 0;"><strong>Year:</strong> <span id="d-year"></span></p>
            </div>

            <p id="d-summary" style="margin-top: 10px; font-size: 13px; font-style: italic; color: var(--sub-text); line-height: 1.4;"></p>
        </div>
    </div>

    <div style="padding: 0 20px;">
        <p id="d-desc" style="font-size: 14px; color: var(--text-color); line-height: 1.5; border-top: 1px solid #333; padding-top: 15px;"></p>
    </div>

    <hr style="border: none; border-bottom: 1px solid #222; margin: 20px;">
    
    <div class="section-title">Episodes</div>
    <div id="ep-list" style="padding-bottom: 40px;"></div>

</div>
</div>

    <div id="d-desc" style="padding: 0 20px; font-size: 13px; color: #ccc;"></div>
    <hr style="border-color:#333; margin: 20px;">
    
    <div class="section-title">Episodes</div>
    <div id="ep-list"></div>

</div>

<script src="stories.js"></script>
<script src="app.js"></script> 

<script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const fromWhere = params.get('from'); 
    const fromString = fromWhere ? `&from=${fromWhere}` : "";
    let currentType = "";

    if (typeof db === 'undefined') {
        alert("Error: stories.js is not loaded!");
    } else {
        const data = db[id];

        if (data) {
            currentType = data.type;

            document.getElementById("d-cover").src = data.cover;
            document.getElementById("d-title").innerText = data.title;
            document.getElementById("d-stats").innerText = data.stats;
            document.getElementById("d-desc").innerText = data.desc;

            document.getElementById("d-author").innerText = data.author || "Unknown";
            document.getElementById("d-year").innerText = data.year || "N/A";
            document.getElementById("d-summary").innerText = data.summary || "";

            document.getElementById("btn-save").onclick = function() {
                saveBookmark(data.id, data.title, data.type, data.cover);
                alert("Saved to bookmarks!");
            };

            const listDiv = document.getElementById("ep-list");
            listDiv.innerHTML = ""; 

            // --- SCENARIO A: STORY (Smart Language Switcher) ---
            if (data.type === "story") {
                document.querySelector(".section-title").innerText = "Select Language üåê";
                
                // 1. Start Building the Button Group
                let buttonsHTML = '<div class="read-btn-group" style="margin-bottom: 20px;">';
                let firstLang = null; // We need to know which one to open first

                // 2. CHECK: Does Khmer exist?
                if (data.episodes_kh) {
                    buttonsHTML += `
                        <button class="read-btn btn-kh" onclick="showChapters('kh')">
                            Khmer üá∞üá≠
                        </button>`;
                    if (!firstLang) firstLang = 'kh';
                }

                // 3. CHECK: Does English exist?
                if (data.episodes_en) {
                    buttonsHTML += `
                        <button class="read-btn btn-en" onclick="showChapters('en')">
                            English üá¨üáß
                        </button>`;
                    if (!firstLang) firstLang = 'en';
                }

                buttonsHTML += '</div><div id="chapter-container"></div>';
                listDiv.innerHTML = buttonsHTML;
                
                // 4. Open the available language automatically
                if (firstLang) {
                    showChapters(firstLang);
                } else {
                    listDiv.innerHTML += "<div style='color:gray;'>No languages available.</div>";
                }

            } 
            // --- SCENARIO B: COMIC / NOVEL ---
            else {
    // 1. Change the Section Header based on type
    let sectionText = (data.type === "novel") ? "·ûò·û∂·ûè·û∑·ûÄ·û∂ (Chapters)" : "·ûó·û∂·ûÇ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã (Episodes)";
    document.querySelector(".section-title").innerText = sectionText;

    let episodes = Object.keys(data.episodes);
    episodes.sort((a, b) => b - a);
    episodes.forEach(epNum => {
        
        // 2. Change the Item text
        // If novel -> "·ûá·üÜ·ûñ·ûº·ûÄ", if comic -> "·ûó·û∂·ûÇ"
        let label = (data.type === "novel") ? "·ûá·üÜ·ûñ·ûº·ûÄ·ûë·û∏" : "·ûó·û∂·ûÇ";

        listDiv.innerHTML += `
            <div class="chapter-item" onclick="location.href='read.html?id=${id}&ep=${epNum}${fromString}'">
                <span>${label} ${epNum}</span>
                <span style="color:gray;">FREE</span>
            </div>
        `;
    });
}
        } else {
            document.getElementById("d-title").innerText = "Story Not Found";
        }
    }

    // --- STORY CHAPTER LIST LOGIC ---
    function showChapters(lang) {
        const container = document.getElementById("chapter-container");
        const data = db[id];
        container.innerHTML = ""; 

        let episodes = (lang === 'kh') ? data.episodes_kh : data.episodes_en;
        
        let epKeys = Object.keys(episodes).sort((a,b) => b - a); 
        
        epKeys.forEach(epNum => {
            container.innerHTML += `
                <div class="chapter-item" onclick="location.href='read.html?id=${id}&lang=${lang}&ep=${epNum}${fromString}'">
                    <span>${lang === 'kh' ? '·ûó·û∂·ûÇ' : 'Episode'} ${epNum}</span>
                    <span style="color:gray;">Read</span>
                </div>
            `;
        });
    }

    function goUp() {
        if (fromWhere === 'home') {
            location.href = 'index.html';
        } else if (currentType) {
            location.href = `world.html?type=${currentType}`;
        } else {
            location.href = 'index.html';
        }
    }
</script>
</body>
</html>