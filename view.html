<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>AAN Reader</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="apple-touch-icon" href="images/icons/app_icon.png">
    <link rel="icon" type="image/png" href="images/icons/app_icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AAN Reader">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
</head>
<body>
<div class="app-container">

    <div class="header">
        <div onclick="history.back()" style="cursor: pointer;">
            <img src="images/icons/icon_back.png" class="icon-back-special" alt="Back">
        </div>

        <div class="header-icons">
            <div class="icon-box" onclick="toggleTheme()">
                <img id="theme-btn" src="images/icons/icon_sun.png" class="icon-btn">
                <span id="theme-text" class="icon-label">Light</span>
            </div>
            <div class="icon-box">
                <img id="btn-save" src="images/icons/icon_bookmark.png" class="icon-btn">
                <span class="icon-label">Saved</span>
            </div>
        </div>
    </div>

    <div class="detail-top-section">
        <img id="d-cover" src="" class="detail-cover-img">
        
        <div class="detail-info-box">
            <h2 id="d-title">Loading...</h2>
            <div id="d-stats" class="detail-meta" style="color:#aaa;"></div>
            
            <div class="detail-meta">
                <span style="color:var(--text-color); font-weight:bold;">Writer:</span> <span id="d-author"></span><br>
                <span style="color:var(--text-color); font-weight:bold;">Year:</span> <span id="d-year"></span>
            </div>

            <div id="d-desc" class="detail-desc-preview"></div>
        </div>
    </div>

    <div id="warning-container" class="warning-box" style="display:none;">
        <span id="d-warning"></span>
    </div>

    <div id="lang-container" class="lang-toggle-container" style="display:none;">
        <button id="btn-kh" class="lang-btn active" onclick="switchLang('kh')">Khmer</button>
        <button id="btn-en" class="lang-btn" onclick="switchLang('en')">English</button>
    </div>

    <div class="chapter-section-title">មាតិកា (Chapter)</div>
    
    <div class="chapter-list-box" id="chapter-list">
        </div>

    <div class="footer">
        © 2026 AAN. All Rights Reserved.
    </div>

    <div id="toast-notification">Notification</div>

</div>

<script src="stories.js"></script>
<script src="app.js"></script> 

<script>
    // --- GLOBAL VARIABLES ---
    let currentStoryData = null;
    let currentActiveEpisodes = null;
    let currentLangCode = 'default';
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    // --- 1. THEME LOGIC ---
    const themeBtn = document.getElementById("theme-btn");
    const themeText = document.getElementById("theme-text");

    // --- 2. LOAD DATA ---
    if (typeof db !== 'undefined') {
        currentStoryData = db[id];
        if (currentStoryData) {
            // A. Populate Basic Info
            document.getElementById("d-cover").src = currentStoryData.cover;
            document.getElementById("d-title").innerText = currentStoryData.title;
            document.getElementById("d-stats").innerText = currentStoryData.stats;
            document.getElementById("d-author").innerText = currentStoryData.author || "Unknown";
            document.getElementById("d-year").innerText = currentStoryData.year || "N/A";
            document.getElementById("d-desc").innerText = currentStoryData.desc;

            // B. Warning Logic
            if (currentStoryData.warning && currentStoryData.warning.trim() !== "") {
                document.getElementById("warning-container").style.display = "block";
                document.getElementById("d-warning").innerText = currentStoryData.warning;
            }

            // C. Language Logic & Initial Render
            const hasKh = !!currentStoryData.episodes_kh || (currentStoryData.type !== 'story' && currentStoryData.episodes);
            const hasEn = !!currentStoryData.episodes_en;
            const langContainer = document.getElementById("lang-container");

            if (currentStoryData.type === 'story') {
                if (hasKh && hasEn) {
                    langContainer.style.display = "flex"; 
                    switchLang('kh'); // Default to Khmer
                } else if (hasEn) {
                    langContainer.style.display = "none";
                    switchLang('en');
                } else {
                    langContainer.style.display = "none";
                    switchLang('kh');
                }
            } else {
                // Novels/Comics
                langContainer.style.display = "none";
                currentLangCode = 'default';
                currentActiveEpisodes = currentStoryData.episodes;
                renderChapterList(); // Draw the list
            }

            // D. Bookmark Logic
            setupBookmarkButton(currentStoryData);
        }
    }

    // --- 3. SWITCH LANGUAGE FUNCTION ---
    function switchLang(lang) {
        currentLangCode = lang;
        
        // Update Buttons UI
        document.getElementById('btn-kh').className = (lang === 'kh') ? 'lang-btn active' : 'lang-btn';
        document.getElementById('btn-en').className = (lang === 'en') ? 'lang-btn active' : 'lang-btn';

        // Update Data Source
        if (lang === 'kh') {
            currentActiveEpisodes = currentStoryData.episodes_kh;
        } else {
            currentActiveEpisodes = currentStoryData.episodes_en;
        }

        // Re-draw the list
        renderChapterList();
    }

    // --- 4. RENDER CHAPTERS (FIXED: FAST & DIRECT LINK) ---
    function renderChapterList() {
        const listDiv = document.getElementById("chapter-list");
        
        // Safety Check
        if (!currentActiveEpisodes) {
            listDiv.innerHTML = "<div style='padding:20px; text-align:center; color:#666;'>No chapters available.</div>";
            return;
        }

        // 1. Get Highlight from Storage (Always Fresh!)
        const lastReadEp = localStorage.getItem('last_read_' + id);

        // 2. Prepare HTML String (Faster than creating elements one by one)
        let html = "";
        
        // Sort keys (Newest First)
        let keys = Object.keys(currentActiveEpisodes).sort((a, b) => b - a);

        keys.forEach(epNum => {
            // Label Logic
            let label = "";
            if (epNum == '0') {
                label = (currentLangCode === 'kh' || (currentLangCode === 'default' && currentStoryData.type === 'novel')) ? "អារម្ភកថា" : "Intro / Prologue";
            } else {
                let prefix = (currentStoryData.type === "novel") ? "Chapter " : "Episode ";
                if (currentLangCode === 'kh' || (currentLangCode === 'default' && currentStoryData.type === 'novel')) {
                    prefix = (currentStoryData.type === "novel") ? "ជំពូកទី " : "ភាគ ";
                }
                label = prefix + epNum;
            }

            // Check Highlight
            let activeClass = (lastReadEp == epNum) ? " last-read" : "";
            // Uses the new "resume-text" class defined in CSS
let resumeText = (lastReadEp == epNum) ? '<span class="resume-text">(RESUME)</span>' : '';

            // GENERATE LINK (Direct URL for reliability)
            let targetUrl = `read.html?id=${id}&ep=${epNum}`;
            if (currentLangCode !== 'default') {
                targetUrl += `&lang=${currentLangCode}`;
            }

            // Build Row HTML (onclick handles both saving and navigation)
            html += `
                <div class="chapter-row ${activeClass}" onclick="saveAndGo('${epNum}', '${targetUrl}')">
                    <span>${label} ${resumeText}</span>
                    <span class="free-tag">FREE</span>
                </div>
            `;
        });

        // 3. Update Screen ONCE
        listDiv.innerHTML = html;
    }

    // Helper to save progress before moving
    function saveAndGo(epNum, url) {
        localStorage.setItem('last_read_' + id, epNum);
        location.href = url;
    }

    // --- 5. EVENT LISTENER (THE FIX FOR BACK BUTTON) ---
    window.addEventListener('pageshow', function(event) {
        // This runs every time the page appears (even from Back button)
        if (currentStoryData && currentActiveEpisodes) {
            renderChapterList();
        }
    });

    // --- 6. BOOKMARK SETUP ---
    function setupBookmarkButton(item) {
        const btnSave = document.getElementById("btn-save");
        let bookmarks = JSON.parse(localStorage.getItem("khatoon_bookmarks")) || [];
        
        let isSaved = bookmarks.some(b => b.id === item.id);
        if(btnSave) btnSave.src = isSaved ? "images/icons/icon_bookmark_red.png" : "images/icons/icon_bookmark.png";

        if(btnSave) {
            btnSave.onclick = function() {
                bookmarks = JSON.parse(localStorage.getItem("khatoon_bookmarks")) || [];
                let index = bookmarks.findIndex(b => b.id === item.id);

                if (index > -1) {
                    bookmarks.splice(index, 1);
                    btnSave.src = "images/icons/icon_bookmark.png";
                    showToast("Removed from Library");
                } else {
                    bookmarks.push({ id: item.id, title: item.title, type: item.type, cover: item.cover });
                    btnSave.src = "images/icons/icon_bookmark_red.png";
                    showToast("Saved to Library");
                }
                localStorage.setItem("khatoon_bookmarks", JSON.stringify(bookmarks));
            };
        }
    }

    function showToast(msg) {
        const t = document.getElementById("toast-notification");
        if(t) {
            t.innerText = msg;
            t.className = "show";
            setTimeout(() => t.className = t.className.replace("show", ""), 3000);
        }
    }
</script>
</body>
</html>