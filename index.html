<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAN Reader</title>
    
    <link rel="stylesheet" href="style.css">

    <link rel="apple-touch-icon" href="images/icons/app_icon.png">
    
    <link rel="icon" type="image/png" href="images/icons/app_icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
</head>
<body>

<div class="app-container">
    
    <div class="header">
        <div class="header-logo-group" style="display: flex; align-items: center; gap: 10px;">
            <img src="images/icons/icon_logo.png" class="app-logo" alt="Logo">
        </div>
        
        <div class="header-icons">
            <div class="icon-box" onclick="toggleTheme()">
                <img id="theme-icon" src="images/icons/icon_sun.png" class="icon-btn" style="width:20px; height:20px;">
                <span id="theme-text" class="icon-label">Light</span>
            </div>
            
            <div class="icon-box" onclick="toggleBookmarks()">
                <img id="btn-library" src="images/icons/icon_library.png" class="icon-btn" style="width:20px; height:20px;">
                <span class="icon-label">Library</span>
            </div>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search stories..." onkeyup="handleSearch(event)">
        <button onclick="performSearch()">
            <img src="images/icons/icon_search.png" alt="Search">
        </button>
    </div>

    <div id="section-history" class="section-card" style="display:none;">
            <div class="card-title">● Continue Reading</div>
            <div id="list-history" class="scroll-container"></div>
        </div>

    <div class="ad-banner-wrapper">
        <img src="images/covers/banner_story.jpg" class="ad-banner" alt="Ad 1">
    </div>

    <div class="section-card">
        <div class="card-title">● Story world</div>
        <div id="list-story" class="scroll-container"></div>
        <a href="world.html?type=story" class="show-more-btn">បង្ហាញច្រើនទៀត</a>
    </div>

    <div class="ad-banner-wrapper">
        <img src="images/covers/banner_novel.jpg" class="ad-banner" alt="Ad 2">
    </div>

    <div class="section-card">
        <div class="card-title">● Novel world</div>
        <div id="list-novel" class="scroll-container"></div>
        <a href="world.html?type=novel" class="show-more-btn">បង្ហាញច្រើនទៀត</a>
    </div>

    <div class="ad-banner-wrapper">
        <img src="images/covers/banner_comic.jpg" class="ad-banner" alt="Ad 3">
    </div>

    <div class="section-card">
        <div class="card-title">● Comic world</div>
        <div id="list-comic" class="scroll-container"></div>
        <a href="world.html?type=comic" class="show-more-btn">បង្ហាញច្រើនទៀត</a>
    </div>


    <div class="footer">
        © 2026 AAN. All Rights Reserved.
    </div>

    <div id="bookmark-overlay" class="bookmark-overlay" onclick="toggleBookmarks()"></div>
    <div id="bookmark-drawer" class="bookmark-drawer">
        <div class="drawer-header">
            <span>My Library</span>
            <span onclick="toggleBookmarks()" style="cursor:pointer;">✕</span>
        </div>
        <div id="bookmark-list"></div>
    </div>

</div>

<script src="stories.js"></script>
<script src="app.js"></script>

<script>
    // --- 1. THEME TOGGLE LOGIC ---
    const themeIcon = document.getElementById("theme-icon");
    const themeText = document.getElementById("theme-text");

    function updateThemeUI(isLight) {
        if (isLight) {
            document.body.classList.add("light-mode");
            if(themeIcon) themeIcon.src = "images/icons/icon_moon.png"; 
            if(themeText) themeText.innerText = "Dark"; 
        } else {
            document.body.classList.remove("light-mode");
            if(themeIcon) themeIcon.src = "images/icons/icon_sun.png"; 
            if(themeText) themeText.innerText = "Light";
        }
    }

    const savedTheme = localStorage.getItem("theme");
    updateThemeUI(savedTheme === "light");

    function toggleTheme() {
        document.body.classList.toggle("light-mode");
        const isLight = document.body.classList.contains("light-mode");
        localStorage.setItem("theme", isLight ? "light" : "dark");
        updateThemeUI(isLight);
    }

    // --- 2. AUTOMATIC STORY LOADER (UPDATED WITH HISTORY) ---
    
    // Helper function to create the HTML for a card (prevents duplicate code)
    function createStoryCard(item) {
        let badgeHTML = item.badge ? `<span class="badge ${item.badge === "NEW" ? "badge-new" : "badge-up"}">${item.badge}</span>` : "";
        return `
            <div class="story-card" onclick="location.href='view.html?id=${item.id}&from=home'">
                <div style="position:relative;">
                    ${badgeHTML} 
                    <img src="${item.cover}" class="story-cover">
                </div>
                <div class="story-title">${item.title}</div>
                <div class="story-stats">${item.stats}</div>
            </div>
        `;
    }

    // A. LOAD HISTORY (Continue Reading)
    const historySection = document.getElementById("section-history");
    const historyList = document.getElementById("list-history");
    
    // Get history from storage
    const historyIds = JSON.parse(localStorage.getItem('khatoon_history')) || [];

    if (historyIds.length > 0 && historyList) {
        let hasHistoryData = false;
        historyIds.forEach(id => {
            if (db[id]) {
                // Add card to history list
                historyList.innerHTML += createStoryCard(db[id]);
                hasHistoryData = true;
            }
        });
        
        // Show the history section if we found stories
        if (hasHistoryData && historySection) {
            historySection.style.display = "block";
        }
    }

    // B. LOAD ALL OTHER SECTIONS
    const storyList = document.getElementById("list-story");
    const novelList = document.getElementById("list-novel");
    const comicList = document.getElementById("list-comic");

    for (let key in db) {
        let item = db[key];
        
        if (item.released === false) { continue; } 

        let cardHTML = createStoryCard(item);

        if (item.type === 'story' && storyList) storyList.innerHTML += cardHTML;
        else if (item.type === 'novel' && novelList) novelList.innerHTML += cardHTML;
        else if (item.type === 'comic' && comicList) comicList.innerHTML += cardHTML;
    }

    enableDragScroll();

    // --- 3. BOOKMARK DRAWER LOGIC ---
    function toggleBookmarks() {
        const overlay = document.getElementById("bookmark-overlay");
        const drawer = document.getElementById("bookmark-drawer");
        const list = document.getElementById("bookmark-list");

        overlay.classList.toggle("active");
        drawer.classList.toggle("active");

        if (drawer.classList.contains("active")) {
            const bookmarks = JSON.parse(localStorage.getItem("khatoon_bookmarks")) || [];
            list.innerHTML = ""; 

            if (bookmarks.length === 0) {
                list.innerHTML = "<p style='color:gray; text-align:center;'>No saved stories yet.</p>";
            } else {
                bookmarks.forEach((book, index) => {
                    list.innerHTML += `
                        <div class="bookmark-item">
                            <img src="${book.cover}" onclick="location.href='view.html?id=${book.id}'">
                            <div class="bookmark-info" onclick="location.href='view.html?id=${book.id}'">
                                <div style="font-weight:bold; font-size:14px; color:white;">${book.title}</div>
                                <div style="font-size:10px; color:gray;">${book.type.toUpperCase()}</div>
                            </div>
                            <button class="btn-remove" onclick="removeBookmark(${index})">
                                <img src="images/icons/icon_trash.png" alt="Delete">
                            </button>
                        </div>
                    `;
                });
            }
        }
    }

    function removeBookmark(index) {
        let bookmarks = JSON.parse(localStorage.getItem("khatoon_bookmarks")) || [];
        bookmarks.splice(index, 1);
        localStorage.setItem("khatoon_bookmarks", JSON.stringify(bookmarks));
        
        // Refresh the list immediately without closing
        const list = document.getElementById("bookmark-list");
        list.innerHTML = "";
        if (bookmarks.length === 0) {
            list.innerHTML = "<p style='color:gray; text-align:center;'>No saved stories yet.</p>";
        } else {
            bookmarks.forEach((book, idx) => {
                list.innerHTML += `
                    <div class="bookmark-item">
                        <img src="${book.cover}" onclick="location.href='view.html?id=${book.id}'">
                        <div class="bookmark-info" onclick="location.href='view.html?id=${book.id}'">
                            <div style="font-weight:bold; font-size:14px; color:white;">${book.title}</div>
                            <div style="font-size:10px; color:gray;">${book.type.toUpperCase()}</div>
                        </div>
                        <button class="btn-remove" onclick="removeBookmark(${idx})">
                            <img src="images/icons/icon_trash.png" alt="Delete">
                        </button>
                    </div>
                `;
            });
        }
    }
</script>

</body>
</html>